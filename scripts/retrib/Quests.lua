Retrib = Retrib or {}
Retrib.Quest = Retrib.Quest or {}

Retrib.Quests = 
{
	ACureForWhatAilsYou         = {ID =  0, Repeatable = nil, Title = "A Cure for What Ails You"},
    ADullAffair                 = {ID =  1, Repeatable = nil, Title = "A Dull Affair"},
    AFatefulArrival             = {ID =  2, Repeatable = nil, Title = "A Fateful Arrival"},
	AFeastForAll                = {ID =  3, Repeatable =   0, Title = "A Feast for All"},
	Agent13SecretService        = {ID =  4, Repeatable = nil, Title = "Agent 13, Star Sybil Secret Service"},
    ALightHand                  = {ID =  5, Repeatable =   1, Title = "A Light Hand"},
    AllAboard                   = {ID =  6, Repeatable = nil, Title = "All Aboard!"},
    AllRoadsLeadToJeuno         = {ID =  7, Repeatable = nil, Title = "All Roads Lead to Jeuno"},
	AMithranTrajedy             = {ID =  8, Repeatable = nil, Title = "A Mithran Trajedy"},
	AnExplorerFootstepsII       = {ID =  9, Repeatable = nil, Title = "An Explorer's Footsteps II"},
    AStepAbove                  = {ID = 10, Repeatable = nil, Title = "A Step Above"},
    AWomanScorned               = {ID = 11, Repeatable = nil, Title = "A Woman Scorned"},
    BalanceOfPower              = {ID = 12, Repeatable = nil, Title = "Balance of Power"},
    BlindLeadingTheBlind        = {ID = 13, Repeatable = nil, Title = "Blind Leading the Blind"},
	BondsOfMatrimony            = {ID = 14, Repeatable = nil, Title = "Bonds of Matrimony"},
	BringingLightToDarkness	    = {ID = 15, Repeatable = nil, Title = "Bringing Light to the Darkness"},
	CastlesInTheSky             = {ID = 16, Repeatable = nil, Title = "Castles in the Sky"},
    CleansingTheLand            = {ID = 17, Repeatable = nil, Title = "Cleansing The Land"},
	ComedyOfCatastrophies       = {ID = 18, Repeatable = nil, Title = "Comedy of Catastrophes"},
	CostumeParty                = {ID = 19, Repeatable = nil, Title = "Costume Party"},
	CraftingAMasterpiece        = {ID = 20, Repeatable = nil, Title = "Crafting a Masterpiece"},
    CreepyCrawlies              = {ID = 21, Repeatable = nil, Title = "Creepy Crawlies"},
	DarknessDescends            = {ID = 22, Repeatable = nil, Title = "Darkness Descends"},
	DesolationAndSorrow         = {ID = 23, Repeatable = nil, Title = "Desolation & Sorrow"},
	DireAttire                  = {ID = 24, Repeatable = nil, Title = "Dire Attire"},
	DivineInspiration           = {ID = 25, Repeatable = nil, Title = "Divine Inspiration"},
	DucalDiplomacy              = {ID = 26, Repeatable = nil, Title = "Ducal Diplomacy"},
	EggEatersAnonymous          = {ID = 27, Repeatable =   2, Title = "Egg Eaters Anonymous"},
	FallenAngel                 = {ID = 28, Repeatable = nil, Title = "Fallen Angel"},
	FitForABeast                = {ID = 29, Repeatable =   3, Title = "Fit for a Beast"},
    ForgingANewMythic           = {ID = 30, Repeatable = nil, Title = "Forging a New Relic"},
	ForgingANewRelic            = {ID = 31, Repeatable = nil, Title = "Forging a New Relic"},
	ForgottenSecrets            = {ID = 32, Repeatable = nil, Title = "Forgotten Secrets"},
	FunInTheSun                 = {ID = 33, Repeatable =   4, Title = "Fun in the Sun"},
	HealingTheLandII            = {ID = 34, Repeatable = nil, Title = "Healing the Land II"},
	HuntingExpedition           = {ID = 35, Repeatable =   5, Title = "Hunting Expedition"},
	InServiceToTheKing          = {ID = 36, Repeatable = nil, Title = "In Service to the King"},
    InsideInformation           = {ID = 37, Repeatable = nil, Title = "Inside Information"},
    LetItSnow                   = {ID = 38, Repeatable = nil, Title = "Let It Snow"},
	LiftingTheCurse             = {ID = 39, Repeatable = nil, Title = "Lifting the Curse"},
	MagicalMe                   = {ID = 40, Repeatable = nil, Title = "Magical Me"},
	MidnightGarden              = {ID = 41, Repeatable = nil, Title = "Midnight in the Garden of Dawn & Twilight"},
	ParallelUniverse            = {ID = 42, Repeatable = nil, Title = "Parallel Universe"},
	PenPals                     = {ID = 43, Repeatable = nil, Title = "Pen Pals"},
	PresidentialPardon          = {ID = 44, Repeatable = nil, Title = "Presidential Pardon"},
	RandophRedNosedChocobo	    = {ID = 45, Repeatable = nil, Title = "Randolph the Red-Nosed Chocobo"},
    RisenFromTheAshes           = {ID = 46, Repeatable = nil, Title = "Risen From The Ashes"},
    RumorHasIt                  = {ID = 47, Repeatable = nil, Title = "Rumor Has It"},
	SaviourOfTheRealm           = {ID = 48, Repeatable = nil, Title = "Saviour of the Realm"},
	ScavengerHunt               = {ID = 49, Repeatable =   6, Title = "Scavenger Hunt"},
	ScoutingTheLand             = {ID = 50, Repeatable = nil, Title = "Scouting the Land"},
	SharpeningTheAxe            = {ID = 51, Repeatable =   7, Title = "Sharpening the Axe"},
    SlanderLibelUnjustWay       = {ID = 52, Repeatable = nil, Title = "Slander! Libel! And the Unjust Way!"},
    StarlightStarbright         = {ID = 53, Repeatable =   8, Title = "Starlight Starbright"},
	TheBlackMarketBandit        = {ID = 54, Repeatable = nil, Title = "The Black Market Bandit"},
    TheChainsThatBindUs         = {ID = 55, Repeatable = nil, Title = "The Chains That Bind Us"},
	TheEmpireStrikesBackAgain	= {ID = 56, Repeatable = nil, Title = "The Empire Strikes Back...Again?!"},
    TheEmpressesNewClothes      = {ID = 57, Repeatable = nil, Title = "The Empress' New Clothes"},
    TheFungusAmongUs        	= {ID = 58, Repeatable = nil, Title = "The Fungus Among Us"},
    TheGiftOfGiving             = {ID = 59, Repeatable =   9, Title = "The Gift of Giving"},
    TheGreatHarvest             = {ID = 60, Repeatable =  10, Title = "The Great Harvest"},
    TheHauntingOfKarijaMarija   = {ID = 61, Repeatable = nil, Title = "The Haunting of Karija-Marija"},
	TheKeyToThePast             = {ID = 62, Repeatable = nil, Title = "The Key to the Past"},
    TheLastStand                = {ID = 63, Repeatable = nil, Title = "The Last Stand"},
	TheMissingScroll            = {ID = 64, Repeatable = nil, Title = "The Missing Scroll"},
    TheMoreYouGnoll             = {ID = 65, Repeatable = nil, Title = "The More You Gnoll"},
    ThePriceOfKnowledge         = {ID = 66, Repeatable = nil, Title = "The Price Of Knowledge"},
    TheSandsofTime              = {ID = 67, Repeatable = nil, Title = "The Sands of Time"},
    TheUltimateHeist            = {ID = 68, Repeatable = nil, Title = "The Ultimate Heist"},
    ThoseWhoLurkInShadows       = {ID = 69, Repeatable = nil, Title = "Those Who Lurk in the Shadows"},
    TongueTiedAndTwisted 	    = {ID = 70, Repeatable = nil, Title = "Tongue-tied and Twisted"},
    TraitorInTheTenshodo        = {ID = 71, Repeatable = nil, Title = "Traitor in the Tenshodo"},
	TravellingSynergists        = {ID = 72, Repeatable = nil, Title = "Travelling Synergists"},
	TrickOrTreant               = {ID = 73, Repeatable =  11, Title = "Trick or Treant"},
	Vanityel                    = {ID = 74, Repeatable = nil, Title = "Vanity\'el"},
    WatchingAndWaiting          = {ID = 75, Repeatable = nil, Title = "Watching and Waiting"},
    WantedDeadOrDead            = {ID = 76, Repeatable = nil, Title = "Wanted: Dead or...Just Dead"},
	WelcomeToRetribrati            = {ID = 77, Repeatable = nil, Title = "Welcome to Retribrati"},
    WhatLiesBelow               = {ID = 78, Repeatable = nil, Title = "What Lies Below"},
    WishUponAStar               = {ID = 79, Repeatable = nil, Title = "Wish Upon A Star"}
}

Retrib.CMD = {
    Text     = 1,
    CText	 = 2,
    Aside	 = 3,
    Info     = 4,
    Prompt   = 5,
    NewQuest = 6,
    NewPart  = 7,
    EndQuest = 8,
    EndPart  = 9,
    AddVar   = 10,
    SetVar   = 11,
    SetTimer = 12,
    AddTally = 13,
    SetItem  = 14,
    SetGil   = 15,
    SetQty   = 16,
    SetExtra = 17,
    Give	 = 18,
    Take     = 19,
    AddGil   = 20,
    AddKey   = 21,
    DelKey   = 22,
    AddFame  = 23,
    SetTitle = 24,
    SendMenu = 25,
    AddTier  = 26
}

Retrib.Color = {
    Red    = 13, -- No Speaker Say (Default Red)
    Purple = 14, -- No Speaker Shout (Default Purple)
    Blue   = 15, -- No Speaker Party (Default Light Blue)
    Green  = 16, -- No Speaker LS 1 (Default Green)
    Yellow = 29	 -- System Text (Yellow)
}

Retrib.Text = function(PC, Message) PC:PrintToPlayer(Message, Retrib.Color.Yellow ) end
Retrib.Info = function(PC, Message) PC:PrintToPlayer(Message, Retrib.Color.Green)   end
Retrib.Tip  = function(PC, Message) PC:PrintToPlayer(Message, Retrib.Color.Blue )   end

Retrib.Talk = function(PC, NPC, Message)
	local Name = NPC:getName():gsub("_", " ").." : "
	Message = Name..Message
	PC:PrintToPlayer(Message, Retrib.Color.Yellow)
end

Retrib.Append = function(PC, Message)
	Message = "  "..Message
	PC:PrintToPlayer(Message, Retrib.Color.Yellow)
end

Retrib.Line = function(PC)
	PC:PrintToPlayer("  ", Retrib.Color.Yellow)
end

function CapAll (String)
	return string.upper(String)
end

function CapFirst (String)
	return String:gsub("^%l", string.upper)
end

function LowerAll (String)
	return string.lower(String)
end

function NewChallenge (PC, Challenge)
	PC:injectActionPacket(4, 918)
    PC:PrintToPlayer("New Challenge: "..Challenge, Retrib.Color.Blue)
end

function SimpleEvent (PC, NPC)
	NPC:setLocalVar("OriginalRot",NPC:getRotPos())
	NPC:lookAt(PC:getPos())

	PC:startEvent(999)
	NPC:timer(1500, function(NPC)
		NPC:SetRotation(NPC:getLocalVar("OriginalRot"))
	end)
	PC:timer(1500, function(PC)
		PC:SilentRelease()
	end)
end

function StartRetribQuest(PC, Quest)
	PC:injectActionPacket(4, 918)
	PC:StartRetribQuest(Quest.ID, Quest.Repeatable)
	PC:PrintToPlayer(string.format("Quest Added: %s", Quest.Title), Retrib.Color.Green)
end

function CompleteRetribQuest(PC, Quest)
    PC:timer(750, function(PC)
        PC:PrintToPlayer(string.format("Quest Completed: %s", Quest.Title), Retrib.Color.Green)
        PC:injectActionPacket(5, 58)
        PC:AddRetribQuestStatus(Quest.ID)
        PC:CompleteRetribQuest(Quest.ID)
    end)
end

function RetribEvent(PC, NPC, Quest, ...)

	local ID     = require("scripts/zones/"..PC:getZoneName().."/IDs")
    local QID    = Quest.ID

	local Name   = NPC:getName():gsub("_", " ").." : "
	local Space  = "  "
	local Append = false
	
	local Events = (...)

	local Time = 0
	local Delay = 2250
	
	NPC:setLocalVar("OriginalRot",NPC:getRotPos())
	NPC:lookAt(PC:getPos())
	PC:startEvent(999)

	for Key, Value in pairs(...) do

		local Command = Events[Key][1]
		local Data    = Events[Key][2] or nil
		local Option  = Events[Key][3] or nil
		
		switch (Command) : caseof
		{
			[Retrib.CMD.Text]      = function(X)
                                Data = (Append and Space or Name)..Data
                                PC:timer(Time, function(PC)
                                    PC:PrintToPlayer(Data, Retrib.Color.Yellow) 
                                end)
                                Append = not Append
                                Time = Time + Delay
                            end,
			[Retrib.CMD.CText]     = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:PrintToPlayer(Data, Retrib.Color.Yellow) 
                                end)
                                Time = Time + Delay
                            end,
			[Retrib.CMD.Aside] = function(X)
                                PC:timer(Time, function(PC)
                                    PC:PrintToPlayer(Data, Retrib.Color.Green) 
                                end)
                                Time = Time + Delay
                            end,
			[Retrib.CMD.Info]      = function(X)
                                PC:timer(Time, function(PC)
                                    PC:PrintToPlayer(Data, Retrib.Color.Blue)
                                end)
                                if Option then
                                    PC:AddSynergyTier()
                                end
						    end,
			[Retrib.CMD.Prompt]    = function(X) 
                                PC:timer(Time, function(PC) 
                                    PC:PrintToPlayer(Data, Retrib.Color.Yellow)
                                end)
						    end,
			[Retrib.CMD.NewQuest]  = function(X)
                                PC:timer(Time + 750, function(PC)
                                    PC:StartRetribQuest(QID, Quest.Repeatable)
                                    PC:PrintToPlayer(string.format("Quest Added: %s", Quest.Title), Retrib.Color.Green)
                                    PC:injectActionPacket(4, 918)
                                end)
						    end,
			[Retrib.CMD.EndQuest]  = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:CompleteRetribQuest(QID)
                                    PC:AddRetribQuestStatus(QID)
                                end)
                                PC:timer(Time + 750, function(PC)
                                    PC:PrintToPlayer(string.format("Quest Completed: %s", Quest.Title), Retrib.Color.Green)
                                    PC:injectActionPacket(5, 58)
                                end)
						    end,
			[Retrib.CMD.NewPart]   = function(X)
                                PC:timer(Time + 750, function(PC)
                                    PC:AddRetribQuestStatus(QID)
                                    PC:PrintToPlayer(Data, Retrib.Color.Green)
                                    PC:injectActionPacket(4, 918)
                                end)
						    end,
			[Retrib.CMD.EndPart]   = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:AddRetribQuestStatus(QID)
                                end)
                                PC:timer(Time + 750, function(PC)
                                    PC:PrintToPlayer(string.format("%s Stage %s Completed!", Quest.Title, Data), Retrib.Color.Green)
                                    PC:injectActionPacket(5, 58)
                                end)
						    end,
			[Retrib.CMD.AddVar]    = function(X)
                                if Data then
                                    PC:timer(Time, function(PC)
                                        PC:AddRetribQuestStatus(Data)
                                    end)
                                else
                                    PC:timer(Time, function(PC) 
                                        PC:AddRetribQuestStatus(QID)
                                    end)
                                end
						    end,
			[Retrib.CMD.SetVar]    = function(X)
                                PC:timer(Time, function(PC)
                                    PC:SetRetribQuestStatus(QID, Data)
                                end)
						    end,
			[Retrib.CMD.SetTimer]  = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:SetRetribQuestTimer(QID, os.time() + Data)
                                end)
						    end,
			[Retrib.CMD.AddTally]  = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:AddRetribQuestTally(QID)
                                end)
						    end,
			[Retrib.CMD.SetItem]   = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:SetRetribQuestItem(QID, Data)
                                end)
						    end,
			[Retrib.CMD.SetGil]    = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:SetRetribQuestGil(QID, Data)
                                end)
						    end,
			[Retrib.CMD.SetQty]    = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:SetRetribQuestQty(QID, Data)
                                end)
						    end,
			[Retrib.CMD.SetExtra]  = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:SetRetribQuestExtra(QID, Data)
                                end)
						    end,
			[Retrib.CMD.Give]      = function(X)
                                PC:timer(Time, function(PC)
                                    PC:addItem(Data)
                                    PC:messageSpecial(ID.text.ITEM_OBTAINED, Data)
                                end)
						    end,
			[Retrib.CMD.Take]      = function(X)
                                PC:timer(Time, function(PC)
                                    PC:tradeComplete()
                                end)
						    end,
			[Retrib.CMD.AddGil]    = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:addGil(Data)
                                    PC:messageSpecial(ID.text.GIL_OBTAINED, Data)
                                end)
						    end,
			[Retrib.CMD.AddKey]    = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:addKeyItem(Data)
                                    PC:messageSpecial(ID.text.KEYITEM_OBTAINED, Data)
                                end)
						    end,
			[Retrib.CMD.DelKey]    = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:delKeyItem(Data)
                                end)
						    end,
			[Retrib.CMD.AddFame]   = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:addFame(Data, Option)
                                end)
						    end,
			[Retrib.CMD.SetTitle]  = function(X)
                                PC:timer(Time, function(PC) 
                                    PC:addTitle(Data)
                                end)
						    end,
			[Retrib.CMD.SendMenu]  = function(X)
                                PC:timer(Time + 500, function(PC)
                                    PC:SendSelectionMenu(Data)
                                end)
						    end,
			[Retrib.CMD.AddTier]   = function(X)
                                PC:timer(Time, function(PC)
                                    PC:AddSynergyTier()
                                end)
						    end,
		}
	end

	NPC:timer(Time, function(NPC)
		NPC:SetRotation(NPC:getLocalVar("OriginalRot"))
	end)
	PC:timer(Time, function(PC) PC:SilentRelease() end)
end

function ConfirmItem (Item, Slot, QT) 
	Item:confirmSlot(Slot, QT)
end

function ConfirmTrade (PC) 
	PC:confirmTrade()
end

function TakeItems (PC)
	PC:tradeComplete()
end

function TryTrade (PC, Item, Qty)
	local ID = require("scripts/zones/"..PC:getZoneName().."/IDs")
	if PC:getFreeSlotsCount() > 0 then
		PC:addItem(Item, Qty)
		PC:messageSpecial(ID.text.ITEM_OBTAINED,Item)
		return true
	else
		PC:messageSpecial(ID.text.ITEM_CANNOT_BE_OBTAINED, Item)
		return false
	end
end